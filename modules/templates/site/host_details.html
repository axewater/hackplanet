{% extends 'base.html' %}

{% block content %}
{% with messages = get_flashed_messages() %}
{% if messages %}
<div>
    {% for message in messages %}
    <div class="alert alert-info" role="alert">{{ message }}</div>
    {% endfor %}
</div>
{% endif %}
{% endwith %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="{{ url_for('static', filename='js/host_details.js') }}"></script>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" integrity="sha512-Evv84Mr4kqVGRNSgIGL/F/aIDqQb7xQ2vcrdIwxfjThSH8CSR7PBEakCr51Ck+w+/U6swU2Im1vVX0SVk9ABhg==" crossorigin="anonymous" referrerpolicy="no-referrer" />

<div class="container mt-4">
    <a href="{{ url_for('main.hacking_labs') }}" class="btn btn-secondary">Back to Hacking Labs</a>

    <div class="card glass-panel">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <h1 class="mb-0">{{ host.name }} Details</h1>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <table class="table table-striped">
                        <tbody>
                            <tr>
                                <th>OS</th>
                                <td>{{ host.os }}</td>
                            </tr>
                            <tr>
                                <th>Difficulty</th>
                                <td>{{ host.difficulty }}</td>
                            </tr>
                            <tr>
                                <th>IP</th>
                                <td>{{ host.ip }}</td>
                            </tr>
                            <tr>
                                <th>Status</th>
                            </tr>
                            <tr>
                                <th>Rating</th>
                                <td>{{ host.rating }}</td>
                            </tr>
                            <tr>
                                <th>Release Date</th>
                                <td>{{ host.release_date }}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header bg-info text-white">
                            <h5 class="mb-0">Hint</h5>
                        </div>
                        <div class="card-body">
                            <p>{{ host.hint }}</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="mt-4">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h2 class="mb-0">Host Ratings</h2>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h4>Average Ratings</h4>
                                <div class="rating-summary">
                                    <p><strong>Difficulty:</strong> <span class="stars" data-rating="{{ host.avg_difficulty_rating }}"></span> <span class="rating-value">({{ host.avg_difficulty_rating }})</span></p>
                                    <p><strong>Fun:</strong> <span class="stars" data-rating="{{ host.avg_fun_rating }}"></span> <span class="rating-value">({{ host.avg_fun_rating }})</span></p>
                                    <p><strong>Realism:</strong> <span class="stars" data-rating="{{ host.avg_realism_rating }}"></span> <span class="rating-value">({{ host.avg_realism_rating }})</span></p>
                                    <p><strong>Overall:</strong> <span class="stars" data-rating="{{ host.overall_rating }}"></span> <span class="rating-value">({{ host.overall_rating }})</span></p>
                                    <p class="review-count"><small>Based on {{ host.reviews|length }} review(s)</small></p>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div id="review-button-container">
                                    {% if host.has_completed_both_flags(current_user.id) %}
                                        {% if host.has_user_reviewed(current_user.id) %}
                                            <button id="delete-review-btn" class="btn btn-danger">Delete Your Review</button>
                                            <button id="edit-review-btn" class="btn btn-primary">Edit Your Review</button>
                                        {% else %}
                                            <button id="add-review-btn" class="btn btn-success">Review This Host</button>
                                        {% endif %}
                                    {% else %}
                                        <div class="alert alert-info">
                                            Complete both user and root flags to review this host.
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <div id="reviews-container" class="mt-4"></div>
                    </div>
                </div>
            </div>
            
            <div class="mt-4">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h2 class="mb-0">Azure VM Management</h2>
                    </div>
                    <div class="card-body">
                        <p>Status: {{ auth_status.status }}</p>
                        {% if auth_status.status != 'Authenticated' %}
                            <div class="alert alert-warning">
                                <p>Error: {{ auth_status.details }}</p>
                            </div>
                        {% endif %}

                        <form id="vm-form" method="post" action="{{ url_for('bp_vm.manage_vm') }}" class="mt-3">
                            <input type="hidden" id="resource_group" name="resource_group" value="CTF">
                            <input type="hidden" id="vm_name" name="vm_name" value="{{ host.azure_vm_id.split('/')[-1] if host.azure_vm_id else '' }}">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            
                            <div class="btn-group" role="group">
                                <button type="button" id="start-btn" class="btn btn-success">Start VM</button>
                                <button type="button" id="stop-btn" class="btn btn-danger">Stop VM</button>
                                
                            </div>
                        </form>
                        <div id="result" class="mt-3 card">
                            <div class="card-body">
                                <h5 class="card-title">VM Status</h5>
                                <p class="card-text" id="status-result">No status information available.</p>
                            </div>
                        </div>
                        <div id="loading" class="spinner-border text-primary mt-3" role="status" style="display: none;">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<input type="hidden" id="host_id" value="{{ host.id }}">

<!-- Review Modal -->
<div class="modal fade" id="reviewModal" tabindex="-1" aria-labelledby="reviewModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="reviewModalLabel">Review Host: {{ host.name }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="review-form">
                    <div class="mb-3">
                        <label for="difficulty-rating" class="form-label">Difficulty</label>
                        <div class="rating-input" id="difficulty-rating">
                            <i class="fas fa-star" data-value="1"></i>
                            <i class="fas fa-star" data-value="2"></i>
                            <i class="fas fa-star" data-value="3"></i>
                            <i class="fas fa-star" data-value="4"></i>
                            <i class="fas fa-star" data-value="5"></i>
                        </div>
                        <input type="hidden" name="difficulty_rating" id="difficulty_rating_input" value="3">
                    </div>
                    <div class="mb-3">
                        <label for="fun-rating" class="form-label">Fun</label>
                        <div class="rating-input" id="fun-rating">
                            <i class="fas fa-star" data-value="1"></i>
                            <i class="fas fa-star" data-value="2"></i>
                            <i class="fas fa-star" data-value="3"></i>
                            <i class="fas fa-star" data-value="4"></i>
                            <i class="fas fa-star" data-value="5"></i>
                        </div>
                        <input type="hidden" name="fun_rating" id="fun_rating_input" value="3">
                    </div>
                    <div class="mb-3">
                        <label for="realism-rating" class="form-label">Realism</label>
                        <div class="rating-input" id="realism-rating">
                            <i class="fas fa-star" data-value="1"></i>
                            <i class="fas fa-star" data-value="2"></i>
                            <i class="fas fa-star" data-value="3"></i>
                            <i class="fas fa-star" data-value="4"></i>
                            <i class="fas fa-star" data-value="5"></i>
                        </div>
                        <input type="hidden" name="realism_rating" id="realism_rating_input" value="3">
                    </div>
                    <div class="mb-3">
                        <label for="comment" class="form-label">Comment (Optional)</label>
                        <textarea class="form-control" id="comment" name="comment" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="submit-review">Submit Review</button>
            </div>
        </div>
    </div>
</div>


{% endblock %}

<style>
.rating-input i {
    cursor: pointer;
    transition: transform 0.2s, color 0.2s;
}
.rating-input i:hover {
    transform: scale(1.2);
}
.rating-input i.hovered {
    color: #FFD700;
}
.rating-input i.active {
    color: #FFD700 !important;
}
@keyframes starPulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.2); }
    100% { transform: scale(1); }
}
.rating-input i.active {
    animation: starPulse 0.3s ease-in-out;
}
.stars {
    display: inline-block;
}
.stars i {
    color: #ccc;
    font-size: 18px;
}
.stars i.active {
    color: #FFD700 !important;
}
.rating-value {
    font-weight: bold;
    margin-left: 5px;
}
.review-count {
    color: #aaa;
    font-style: italic;
    margin-top: 10px;
}
</style>
