{% extends 'base.html' %}

{% block content %}
{% with messages = get_flashed_messages() %}
{% if messages %}
<div>
    {% for message in messages %}
    <div class="alert alert-info" role="alert">{{ message }}</div>
    {% endfor %}
</div>
{% endif %}
{% endwith %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/file_manager.css') }}">
<script src="{{ url_for('static', filename='js/host_status.js') }}"></script>

<div class="container">

    <div class="glass-panel">
        <div class="hackplanet_titles">
            <div class="text-start">
                <a href="{{ url_for('main.ctf_home') }}" class="btn btn-secondary">Back</a>
            </div>
            
            <h1>HackPlanet.EU Hacking Labs</h1>
        </div>

        {% if no_labs %}
            <div class="alert alert-warning" role="alert">
                There are no labs defined. Please ask your administrator to define new labs.
                {% if is_admin %}
                    <a href="{{ url_for('main.lab_manager') }}" class="btn btn-primary">Go to Lab Manager</a>
                {% endif %}
            </div>
        {% else %}
            {% for lab in labs %}
            <div class="lab">
                <div class="labschip">
                    <h2>{{ lab.name }}</h2>
                    {% if lab.image %}
                    <img src="{{ url_for('static', filename='library/images/labs/' + lab.image) }}" alt="{{ lab.name }}" class="lab-image">
                    {% endif %}
                    {% if lab.vpn_file %}
                    <a href="{{ '/static/library/labfiles/' + lab.vpn_file }}" class="download-button btn btn-primary">Download Lab Access</a>
                    <a href="{{ url_for('main.vpn_management', lab_id=lab.id) }}" class="btn btn-secondary">VPN Management</a>
                    {% endif %}
                    <p>{{ lab.description }}</p>
                    <p>VPN Status: <span class="vpn-status-indicator" data-agent-id="{{ lab.vpn_server }}">Loading...</span></p>

                <div class="hosts">
                    {% if lab in labs_without_hosts %}
                        <div class="alert alert-warning" role="alert">
                            There are no hosts defined for this lab.
                            {% if is_admin %}
                                <a href="{{ url_for('main.host_editor') }}" class="btn btn-primary">Add Host</a>
                            {% endif %}
                        </div>
                    {% else %}
                        {% for host in lab.hosts %}
                        <div class="host" data-host-id="{{ host.id }}">
                            <h3>{{ host.name | upper }} </h3>
                            <div class="host-image-container">
                                <img src="{{ '/static/library/images/hosts/' + host.image_url }}" alt="{{ host.name }}" class="host-image">
                            </div>
                            <p>IP Address: {{ host.ip }}</p>
                            <p>Difficulty: {{ host.difficulty }} {% if host.difficulty == 1 %}?{% elif host.difficulty == 2 %}?{% elif host.difficulty == 3 %}?{% elif host.difficulty == 4 %}?{% elif host.difficulty == 5 %}?{% elif host.difficulty == 6 %}?{% elif host.difficulty == 7 %}?{% elif host.difficulty == 8 %}?{% elif host.difficulty == 9 %}?{% elif host.difficulty == 10 %}?{% endif %}</p>
                            <p>Status: <span class="status-indicator" data-agent-id="{{ host.name }}">Loading...</span></p>
                            <a href="{{ url_for('main.host_details', host_id=host.id) }}" class="btn btn-info">Host Details</a>
        
                            <div class="host-inputarea">
                                {% if host.name != 'kalismurf' %}
                                {% if host.flags %}
                                    <div class="flag-input-container">
                                        <input type="text" id="user-flag-{{ host.id }}" placeholder="Enter User Flag" class="flag-input" {% if host.user_flag_completed %}style="display: none;"{% endif %}>
                                        <button type="button" class="btn btn-success" onclick="submitFlag('{{ host.id }}', 'user')" {% if host.user_flag_completed %}disabled{% endif %}>
                                            {% if host.user_flag_completed %}User Flag Hacked{% else %}Submit User Flag{% endif %}
                                        </button>
                                    </div>
                                    <div class="flag-input-container">
                                        <input type="text" id="root-flag-{{ host.id }}" placeholder="Enter Root Flag" class="flag-input" {% if host.root_flag_completed %}style="display: none;"{% endif %}>
                                        <button type="button" class="btn btn-danger" onclick="submitFlag('{{ host.id }}', 'root')" {% if host.root_flag_completed %}disabled{% endif %}>
                                            {% if host.root_flag_completed %}Root Flag Hacked{% else %}Submit Root Flag{% endif %}
                                        </button>
                                    </div>
                                    {% if host.user_flag_completed and host.root_flag_completed %}
                                    <div class="completed-overlay">PWNED!</div>
                                    {% endif %}
                                {% else %}
                                    <p>No flags available for this host.</p>
                                {% endif %}
                                {% else %}
                                <div class="kalismurf-credentials">
                                    <p>username : kali</p>
                                    <p>password : KaliLinux2024!</p>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    {% endif %}
                </div>
            </div>
        </div>
            {% endfor %}
        {% endif %}
    </div>
</div>

<!-- Flag Submission Modal -->
<div class="modal fade" id="flagModal" tabindex="-1" aria-labelledby="flagModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="flagModalLabel"></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="flagModalBody">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script src="{{ url_for('static', filename='js/flag_submission.js') }}"></script>
{% endblock %}
