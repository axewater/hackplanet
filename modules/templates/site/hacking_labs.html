{% extends 'base.html' %}

{% block content %}
{% with messages = get_flashed_messages() %}
{% if messages %}
<div>
    {% for message in messages %}
    <div class="alert alert-info" role="alert">{{ message }}</div>
    {% endfor %}
</div>
{% endif %}
{% endwith %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/file_manager.css') }}">

<div class="container">

    <div class="glass-panel">
        <div class="labs_title">
            <div class="text-start">
                <a href="{{ url_for('main.ctf_home') }}" class="btn btn-secondary">Back</a>
            </div>
            
            <h1>HackPlanet.EU Hacking Labs</h1>
        </div>

        {% if no_labs %}
            <div class="alert alert-warning" role="alert">
                There are no labs defined. Please ask your administrator to define new labs.
                {% if is_admin %}
                    <a href="{{ url_for('main.lab_manager') }}" class="btn btn-primary">Go to Lab Manager</a>
                {% endif %}
            </div>
        {% else %}
            {% for lab in labs %}
            <div class="lab">
                <div class="labschip">
                    <h2>{{ lab.name }}</h2>
                    {% if lab.image %}
                    <img src="{{ url_for('static', filename='library/images/labs/' + lab.image) }}" alt="{{ lab.name }}" class="lab-image">
                    {% endif %}
                    {% if lab.vpn_file %}
                    <a href="{{ '/static/library/labfiles/' + lab.vpn_file }}" class="download-button btn btn-primary">Download Lab Access</a>
                    <a href="{{ url_for('main.vpn_management', lab_id=lab.id) }}" class="btn btn-secondary">VPN Management</a>
                    {% endif %}
                    <p>{{ lab.description }}</p>
                </div>

                <div class="hosts">
                    {% if lab in labs_without_hosts %}
                        <div class="alert alert-warning" role="alert">
                            There are no hosts defined for this lab.
                            {% if is_admin %}
                                <a href="{{ url_for('main.host_editor') }}" class="btn btn-primary">Add Host</a>
                            {% endif %}
                        </div>
                    {% else %}
                        {% for host in lab.hosts %}
                        <div class="host">

                            <h3>{{ host.name | upper }} </h3>
                            <div class="host-image-container">
                                <img src="{{ '/static/library/images/hosts/' + host.image_url }}" alt="{{ host.name }}" class="host-image">
                            </div>
                            <p>IP Address: {{ host.ip }}</p>
                            <p>Difficulty: {{ host.difficulty }} {% if host.difficulty == 1 %}üòä{% elif host.difficulty == 2 %}üôÇ{% elif host.difficulty == 3 %}üòê{% elif host.difficulty == 4 %}üòï{% elif host.difficulty == 5 %}üòü{% elif host.difficulty == 6 %}üò¶{% elif host.difficulty == 7 %}üòß{% elif host.difficulty == 8 %}üò®{% elif host.difficulty == 9 %}üò∞{% elif host.difficulty == 10 %}üò±{% endif %}</p>
                            <p>Status: <span class="status-indicator {{ 'online' if host.status else 'offline' }}" style="color: {{ '#28a745' if host.status else '#dc3545' }};">{{ 'Online' if host.status else 'Offline' }}</span></p>
                            <p>Rating: {% for _ in range(host.rating) %}‚òÖ{% endfor %}{% for _ in range(5 - host.rating) %}‚òÜ{% endfor %}</p>
                            <a href="{{ url_for('main.host_details', host_id=host.id) }}" class="btn btn-info">Host Details</a>
                            {% if is_admin %}
                            <div class="flags">
                                <p style="font-size: 0.2em;">User Flag: {{ host.flags|selectattr('type', '==', 'user')|map(attribute='uuid')|first }}</p>
                                <p style="font-size: 0.2em;">Root Flag: {{ host.flags|selectattr('type', '==', 'root')|map(attribute='uuid')|first }}</p>
                            </div>
                            {% endif %}
            
                            <div class="host-inputarea">
                                {% if host.name != 'kalismurf' %}
                                <div class="flag-input-container">
                                    <input type="text" id="user-flag-{{ host.id }}" placeholder="Enter User Flag" class="flag-input">
                                    <button type="button" class="btn btn-success" onclick="submitFlag('{{ host.id }}', 'user')">Submit</button>
                                </div>
                                <div class="flag-input-container">
                                    <input type="text" id="root-flag-{{ host.id }}" placeholder="Enter Root Flag" class="flag-input">
                                    <button type="button" class="btn btn-danger" onclick="submitFlag('{{ host.id }}', 'root')">Submit</button>
                                </div>
                                {% else %}
                                <div class="kalismurf-credentials">
                                    <p>username : kali</p>
                                    <p>password : KaliLinux2024!</p>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        {% endif %}
    </div>
</div>

<!-- Flag Submission Modal -->
<div class="modal fade" id="flagModal" tabindex="-1" aria-labelledby="flagModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="flagModalLabel"></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="flagModalBody">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script src="{{ url_for('static', filename='js/flag_submission.js') }}"></script>
{% endblock %}
